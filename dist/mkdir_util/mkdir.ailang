// mkdir.ailang - GNU-Compatible Directory Creation Utility
// Usage: mkdir [OPTION]... DIRECTORY...
// Create the DIRECTORY(ies), if they do not already exist.
//
// Options:
//   -p, --parents     Make parent directories as needed, no error if existing
//   -v, --verbose     Print a message for each created directory
//   -m, --mode=MODE   Set file mode (as in chmod), not a=rwx - umask
//   -Z                Set SELinux security context (placeholder)
//   --help            Display this help and exit
//   --version         Output version information and exit

FixedPool.MkdirConfig {
    "parents": Initialize=0
    "verbose": Initialize=0
    "mode_set": Initialize=0
    "mode": Initialize=493
    "context": Initialize=0
}

FixedPool.MkdirStats {
    "created": Initialize=0
    "existed": Initialize=0
    "errors": Initialize=0
}

FixedPool.MkdirConstants {
    "EEXIST": Initialize=17
    "ENOENT": Initialize=2
    "EACCES": Initialize=13
    "ENOTDIR": Initialize=20
    "EROFS": Initialize=30
    "ENOSPC": Initialize=28
    "PATH_MAX": Initialize=4096
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

Function.WriteStdout {
    Input: str: Address
    Body: {
        len = StringLength(str)
        SystemCall(1, 1, str, len)
    }
}

Function.WriteStderr {
    Input: str: Address
    Body: {
        len = StringLength(str)
        SystemCall(1, 2, str, len)
    }
}

Function.IntToString {
    Input: num: Integer
    Output: Address
    Body: {
        IfCondition EqualTo(num, 0) ThenBlock: {
            str = Allocate(2)
            SetByte(str, 0, 48)
            SetByte(str, 1, 0)
            ReturnValue(str)
        }
        
        is_negative = LessThan(num, 0)
        abs_num = num
        IfCondition EqualTo(is_negative, 1) ThenBlock: {
            abs_num = Subtract(0, num)
        }
        
        temp = abs_num
        digits = 0
        WhileLoop GreaterThan(temp, 0) {
            temp = Divide(temp, 10)
            digits = Add(digits, 1)
        }
        
        total_len = digits
        IfCondition EqualTo(is_negative, 1) ThenBlock: {
            total_len = Add(total_len, 1)
        }
        
        str = Allocate(Add(total_len, 1))
        
        pos = 0
        IfCondition EqualTo(is_negative, 1) ThenBlock: {
            SetByte(str, 0, 45)
            pos = 1
        }
        
        i = Subtract(total_len, 1)
        temp = abs_num
        WhileLoop GreaterThan(temp, 0) {
            digit = Modulo(temp, 10)
            SetByte(str, i, Add(48, digit))
            temp = Divide(temp, 10)
            i = Subtract(i, 1)
        }
        
        SetByte(str, total_len, 0)
        ReturnValue(str)
    }
}

Function.OctalToDecimal {
    Input: octal_str: Address
    Output: Integer
    Body: {
        result = 0
        i = 0
        len = StringLength(octal_str)
        
        WhileLoop LessThan(i, len) {
            ch = GetByte(octal_str, i)
            
            IfCondition Or(LessThan(ch, 48), GreaterThan(ch, 55)) ThenBlock: {
                WriteStderr("mkdir: invalid mode: '")
                WriteStderr(octal_str)
                WriteStderr("'\n")
                ReturnValue(-1)
            }
            
            digit = Subtract(ch, 48)
            result = Add(Multiply(result, 8), digit)
            i = Add(i, 1)
        }
        
        ReturnValue(result)
    }
}

Function.PathExists {
    Input: path: Address
    Output: Integer
    Body: {
        statbuf = Allocate(144)
        result = SystemCall(4, path, statbuf)
        Deallocate(statbuf, 144)
        ReturnValue(GreaterEqual(result, 0))
    }
}

Function.IsDirectory {
    Input: path: Address
    Output: Integer
    Body: {
        statbuf = Allocate(144)
        result = SystemCall(4, path, statbuf)
        
        IfCondition LessThan(result, 0) ThenBlock: {
            Deallocate(statbuf, 144)
            ReturnValue(0)
        }
        
        st_mode = Dereference(Add(statbuf, 24))
        Deallocate(statbuf, 144)
        
        is_dir = BitwiseAnd(st_mode, 16384)
        ReturnValue(NotEqual(is_dir, 0))
    }
}

Function.GetParentPath {
    Input: path: Address
    Output: Address
    Body: {
        len = StringLength(path)
        
        real_len = len
        WhileLoop And(GreaterThan(real_len, 0), 
                     EqualTo(GetByte(path, Subtract(real_len, 1)), 47)) {
            real_len = Subtract(real_len, 1)
        }
        
        IfCondition LessEqual(real_len, 0) ThenBlock: {
            result = Allocate(2)
            SetByte(result, 0, 47)
            SetByte(result, 1, 0)
            ReturnValue(result)
        }
        
        last_slash = -1
        i = 0
        WhileLoop LessThan(i, real_len) {
            IfCondition EqualTo(GetByte(path, i), 47) ThenBlock: {
                last_slash = i
            }
            i = Add(i, 1)
        }
        
        IfCondition EqualTo(last_slash, -1) ThenBlock: {
            result = Allocate(2)
            SetByte(result, 0, 46)
            SetByte(result, 1, 0)
            ReturnValue(result)
        }
        
        IfCondition EqualTo(last_slash, 0) ThenBlock: {
            result = Allocate(2)
            SetByte(result, 0, 47)
            SetByte(result, 1, 0)
            ReturnValue(result)
        }
        
        parent = Allocate(Add(last_slash, 1))
        i = 0
        WhileLoop LessThan(i, last_slash) {
            SetByte(parent, i, GetByte(path, i))
            i = Add(i, 1)
        }
        SetByte(parent, last_slash, 0)
        
        ReturnValue(parent)
    }
}

Function.GetErrorString {
    Input: errno: Integer
    Output: Address
    Body: {
        abs_errno = errno
        IfCondition LessThan(errno, 0) ThenBlock: {
            abs_errno = Subtract(0, errno)
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.EEXIST) ThenBlock: {
            ReturnValue("File exists")
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.EACCES) ThenBlock: {
            ReturnValue("Permission denied")
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.ENOENT) ThenBlock: {
            ReturnValue("No such file or directory")
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.ENOTDIR) ThenBlock: {
            ReturnValue("Not a directory")
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.EROFS) ThenBlock: {
            ReturnValue("Read-only file system")
        }
        
        IfCondition EqualTo(abs_errno, MkdirConstants.ENOSPC) ThenBlock: {
            ReturnValue("No space left on device")
        }
        
        ReturnValue("Unknown error")
    }
}

// ============================================================================
// CORE MKDIR FUNCTIONS
// ============================================================================

Function.MakeSingleDir {
    Input: path: Address
    Output: Integer
    Body: {
        result = SystemCall(83, path, MkdirConfig.mode)
        
        IfCondition GreaterEqual(result, 0) ThenBlock: {
            MkdirStats.created = Add(MkdirStats.created, 1)
            
            IfCondition EqualTo(MkdirConfig.verbose, 1) ThenBlock: {
                WriteStderr("mkdir: created directory '")
                WriteStderr(path)
                WriteStderr("'\n")
            }
            
            ReturnValue(0)
        }
        
        abs_error = Subtract(0, result)
        
        IfCondition EqualTo(abs_error, MkdirConstants.EEXIST) ThenBlock: {
            is_dir = IsDirectory(path)
            IfCondition EqualTo(is_dir, 1) ThenBlock: {
                IfCondition EqualTo(MkdirConfig.parents, 1) ThenBlock: {
                    MkdirStats.existed = Add(MkdirStats.existed, 1)
                    ReturnValue(0)
                }
            }
        }
        
        WriteStderr("mkdir: cannot create directory '")
        WriteStderr(path)
        WriteStderr("': ")
        WriteStderr(GetErrorString(result))
        WriteStderr("\n")
        
        MkdirStats.errors = Add(MkdirStats.errors, 1)
        ReturnValue(1)
    }
}

Function.MakeDirectoryWithParents {
    Input: path: Address
    Output: Integer
    Body: {
        exists = PathExists(path)
        IfCondition EqualTo(exists, 1) ThenBlock: {
            is_dir = IsDirectory(path)
            IfCondition EqualTo(is_dir, 1) ThenBlock: {
                MkdirStats.existed = Add(MkdirStats.existed, 1)
                ReturnValue(0)
            } ElseBlock: {
                WriteStderr("mkdir: cannot create directory '")
                WriteStderr(path)
                WriteStderr("': File exists\n")
                MkdirStats.errors = Add(MkdirStats.errors, 1)
                ReturnValue(1)
            }
        }
        
        parent = GetParentPath(path)
        
        parent_len = StringLength(parent)
        is_dot = And(EqualTo(parent_len, 1), EqualTo(GetByte(parent, 0), 46))
        is_root = And(EqualTo(parent_len, 1), EqualTo(GetByte(parent, 0), 47))
        
        IfCondition Not(Or(is_dot, is_root)) ThenBlock: {
            parent_exists = PathExists(parent)
            IfCondition EqualTo(parent_exists, 0) ThenBlock: {
                result = MakeDirectoryWithParents(parent)
                IfCondition NotEqual(result, 0) ThenBlock: {
                    Deallocate(parent, 0)
                    ReturnValue(1)
                }
            } ElseBlock: {
                parent_is_dir = IsDirectory(parent)
                IfCondition EqualTo(parent_is_dir, 0) ThenBlock: {
                    WriteStderr("mkdir: cannot create directory '")
                    WriteStderr(path)
                    WriteStderr("': Not a directory\n")
                    MkdirStats.errors = Add(MkdirStats.errors, 1)
                    Deallocate(parent, 0)
                    ReturnValue(1)
                }
            }
        }
        
        Deallocate(parent, 0)
        
        ReturnValue(MakeSingleDir(path))
    }
}

Function.MakeDirectory {
    Input: path: Address
    Output: Integer
    Body: {
        IfCondition EqualTo(MkdirConfig.parents, 1) ThenBlock: {
            ReturnValue(MakeDirectoryWithParents(path))
        } ElseBlock: {
            ReturnValue(MakeSingleDir(path))
        }
    }
}

// ============================================================================
// ARGUMENT PARSING
// ============================================================================

Function.GetArgs {
    Output: Address
    Body: {
        fd = SystemCall(257, -100, "/proc/self/cmdline", 0, 0)
        IfCondition LessThan(fd, 0) ThenBlock: {
            ReturnValue(0)
        }
        
        buffer = Allocate(4096)
        bytes_read = SystemCall(0, fd, buffer, 4096)
        SystemCall(3, fd)
        
        IfCondition LessEqual(bytes_read, 0) ThenBlock: {
            Deallocate(buffer, 4096)
            ReturnValue(0)
        }
        
        ReturnValue(buffer)
    }
}

Function.StringCompare {
    Input: str1: Address
    Input: str2: Address
    Output: Integer
    Body: {
        i = 0
        WhileLoop 1 {
            ch1 = GetByte(str1, i)
            ch2 = GetByte(str2, i)
            
            IfCondition NotEqual(ch1, ch2) ThenBlock: {
                ReturnValue(0)
            }
            
            IfCondition EqualTo(ch1, 0) ThenBlock: {
                ReturnValue(1)
            }
            
            i = Add(i, 1)
        }
        ReturnValue(1)
    }
}

Function.StringHasPrefix {
    Input: str: Address
    Input: prefix: Address
    Output: Integer
    Body: {
        i = 0
        WhileLoop 1 {
            prefix_ch = GetByte(prefix, i)
            
            IfCondition EqualTo(prefix_ch, 0) ThenBlock: {
                ReturnValue(1)
            }
            
            str_ch = GetByte(str, i)
            
            IfCondition NotEqual(str_ch, prefix_ch) ThenBlock: {
                ReturnValue(0)
            }
            
            i = Add(i, 1)
        }
        ReturnValue(0)
    }
}

Function.ShowHelp {
    Body: {
        WriteStdout("Usage: mkdir [OPTION]... DIRECTORY...\n")
        WriteStdout("Create the DIRECTORY(ies), if they do not already exist.\n")
        WriteStdout("\n")
        WriteStdout("Mandatory arguments to long options are mandatory for short options too.\n")
        WriteStdout("  -m, --mode=MODE   set file mode (as in chmod), not a=rwx - umask\n")
        WriteStdout("  -p, --parents     no error if existing, make parent directories as needed\n")
        WriteStdout("  -v, --verbose     print a message for each created directory\n")
        WriteStdout("  -Z                set SELinux security context of each created directory\n")
        WriteStdout("                      to the default type\n")
        WriteStdout("      --help        display this help and exit\n")
        WriteStdout("      --version     output version information and exit\n")
        WriteStdout("\n")
        WriteStdout("GNU coreutils compatible mkdir implementation in AiLang.\n")
    }
}

Function.ShowVersion {
    Body: {
        WriteStdout("mkdir (AiLang coreutils) 1.0\n")
        WriteStdout("Copyright (C) 2025 AiLang Project\n")
        WriteStdout("License: MIT\n")
        WriteStdout("\n")
        WriteStdout("Written in AiLang - A language designed for human and LLM comprehension.\n")
    }
}

// ============================================================================
// MAIN ROUTINE
// ============================================================================

SubRoutine.Main {
    args_buffer = GetArgs()
    
    IfCondition EqualTo(args_buffer, 0) ThenBlock: {
        WriteStderr("mkdir: failed to read arguments\n")
        SystemCall(60, 1)
    }
    
    pos = 0
    WhileLoop NotEqual(GetByte(args_buffer, pos), 0) {
        pos = Add(pos, 1)
    }
    pos = Add(pos, 1)
    
    max_dirs = 256
    directories = ArrayCreate(max_dirs)
    dir_count = 0
    
    // Parse arguments
    WhileLoop LessThan(pos, 4096) {
        ch = GetByte(args_buffer, pos)
        IfCondition EqualTo(ch, 0) ThenBlock: {
            BreakLoop
        }
        
        first = GetByte(args_buffer, pos)
        
        IfCondition EqualTo(first, 45) ThenBlock: {
            arg_start = pos
            arg_len = 0
            
            WhileLoop And(LessThan(pos, 4096), NotEqual(GetByte(args_buffer, pos), 0)) {
                arg_len = Add(arg_len, 1)
                pos = Add(pos, 1)
            }
            
            flag = Allocate(Add(arg_len, 1))
            i = 0
            WhileLoop LessThan(i, arg_len) {
                SetByte(flag, i, GetByte(args_buffer, Add(arg_start, i)))
                i = Add(i, 1)
            }
            SetByte(flag, arg_len, 0)
            
            IfCondition StringCompare(flag, "--help") ThenBlock: {
                ShowHelp()
                Deallocate(flag, Add(arg_len, 1))
                ArrayDestroy(directories)
                Deallocate(args_buffer, 4096)
                SystemCall(60, 0)
            }
            
            IfCondition StringCompare(flag, "--version") ThenBlock: {
                ShowVersion()
                Deallocate(flag, Add(arg_len, 1))
                ArrayDestroy(directories)
                Deallocate(args_buffer, 4096)
                SystemCall(60, 0)
            }
            
            IfCondition StringCompare(flag, "--parents") ThenBlock: {
                MkdirConfig.parents = 1
            }
            
            IfCondition StringCompare(flag, "--verbose") ThenBlock: {
                MkdirConfig.verbose = 1
            }
            
            IfCondition StringHasPrefix(flag, "--mode=") ThenBlock: {
                mode_str_len = Subtract(arg_len, 7)
                mode_str = Allocate(Add(mode_str_len, 1))
                i = 0
                WhileLoop LessThan(i, mode_str_len) {
                    SetByte(mode_str, i, GetByte(flag, Add(7, i)))
                    i = Add(i, 1)
                }
                SetByte(mode_str, mode_str_len, 0)
                
                mode_val = OctalToDecimal(mode_str)
                Deallocate(mode_str, Add(mode_str_len, 1))
                
                IfCondition GreaterEqual(mode_val, 0) ThenBlock: {
                    MkdirConfig.mode = mode_val
                    MkdirConfig.mode_set = 1
                }
            }
            
            i = 1
            WhileLoop LessThan(i, arg_len) {
                flag_char = GetByte(flag, i)
                
                IfCondition EqualTo(flag_char, 112) ThenBlock: {
                    MkdirConfig.parents = 1
                }
                
                IfCondition EqualTo(flag_char, 118) ThenBlock: {
                    MkdirConfig.verbose = 1
                }
                
                IfCondition EqualTo(flag_char, 109) ThenBlock: {
                    has_mode_attached = LessThan(Add(i, 1), arg_len)
                    IfCondition EqualTo(has_mode_attached, 1) ThenBlock: {
                        mode_len = Subtract(arg_len, Add(i, 1))
                        mode_str = Allocate(Add(mode_len, 1))
                        j = 0
                        k = Add(i, 1)
                        WhileLoop LessThan(k, arg_len) {
                            SetByte(mode_str, j, GetByte(flag, k))
                            j = Add(j, 1)
                            k = Add(k, 1)
                        }
                        SetByte(mode_str, mode_len, 0)
                        
                        mode_val = OctalToDecimal(mode_str)
                        Deallocate(mode_str, Add(mode_len, 1))
                        
                        IfCondition GreaterEqual(mode_val, 0) ThenBlock: {
                            MkdirConfig.mode = mode_val
                            MkdirConfig.mode_set = 1
                        }
                        
                        i = arg_len
                    } ElseBlock: {
                        MkdirConfig.mode_set = -1
                    }
                }
                
                IfCondition EqualTo(flag_char, 90) ThenBlock: {
                    MkdirConfig.context = 1
                }
                
                i = Add(i, 1)
            }
            
            Deallocate(flag, Add(arg_len, 1))
        } ElseBlock: {
            arg_start = pos
            arg_len = 0
            
            WhileLoop And(LessThan(pos, 4096), NotEqual(GetByte(args_buffer, pos), 0)) {
                arg_len = Add(arg_len, 1)
                pos = Add(pos, 1)
            }
            
            IfCondition EqualTo(MkdirConfig.mode_set, -1) ThenBlock: {
                mode_str = Allocate(Add(arg_len, 1))
                i = 0
                WhileLoop LessThan(i, arg_len) {
                    SetByte(mode_str, i, GetByte(args_buffer, Add(arg_start, i)))
                    i = Add(i, 1)
                }
                SetByte(mode_str, arg_len, 0)
                
                mode_val = OctalToDecimal(mode_str)
                Deallocate(mode_str, Add(arg_len, 1))
                
                IfCondition GreaterEqual(mode_val, 0) ThenBlock: {
                    MkdirConfig.mode = mode_val
                    MkdirConfig.mode_set = 1
                } ElseBlock: {
                    MkdirConfig.mode_set = 0
                }
            } ElseBlock: {
                dirname = Allocate(Add(arg_len, 1))
                i = 0
                WhileLoop LessThan(i, arg_len) {
                    SetByte(dirname, i, GetByte(args_buffer, Add(arg_start, i)))
                    i = Add(i, 1)
                }
                SetByte(dirname, arg_len, 0)
                
                IfCondition LessThan(dir_count, max_dirs) ThenBlock: {
                    ArraySet(directories, dir_count, dirname)
                    dir_count = Add(dir_count, 1)
                }
            }
        }
        
        pos = Add(pos, 1)
    }
    
    Deallocate(args_buffer, 4096)
    
    IfCondition EqualTo(dir_count, 0) ThenBlock: {
        WriteStderr("mkdir: missing operand\n")
        WriteStderr("Try 'mkdir --help' for more information.\n")
        ArrayDestroy(directories)
        SystemCall(60, 1)
    }
    
    i = 0
    WhileLoop LessThan(i, dir_count) {
        dir = ArrayGet(directories, i)
        result = MakeDirectory(dir)
        Deallocate(dir, 0)
        i = Add(i, 1)
    }
    
    ArrayDestroy(directories)
    
    IfCondition EqualTo(MkdirConfig.verbose, 1) ThenBlock: {
        IfCondition GreaterThan(dir_count, 1) ThenBlock: {
            WriteStderr("\nðŸ“Š Summary:\n")
            WriteStderr("  Created: ")
            sum_str = IntToString(MkdirStats.created)
            WriteStderr(sum_str)
            Deallocate(sum_str, 0)
            WriteStderr("\n  Already existed: ")
            sum_str = IntToString(MkdirStats.existed)
            WriteStderr(sum_str)
            Deallocate(sum_str, 0)
            WriteStderr("\n  Errors: ")
            sum_str = IntToString(MkdirStats.errors)
            WriteStderr(sum_str)
            Deallocate(sum_str, 0)
            WriteStderr("\n")
        }
    }
    
    exit_code = 0
    IfCondition GreaterThan(MkdirStats.errors, 0) ThenBlock: {
        exit_code = 1
    }
    
    SystemCall(60, exit_code)
}

RunTask(Main)